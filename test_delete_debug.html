<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Debug FASE 3: Eliminaci√≥n de N√∫meros</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f0f4f8; 
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
            background: #f8f9fa;
        }
        .error { border-left-color: #f44336; background: #ffebee; }
        .success { border-left-color: #4caf50; background: #e8f5e8; }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button.danger { background: #f44336; }
        button:hover { opacity: 0.8; }
        pre {
            background: #263238;
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .input-group {
            margin: 10px 0;
        }
        input, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Debug FASE 3: Eliminaci√≥n de N√∫meros</h1>
        <p>Esta p√°gina prueba los endpoints de eliminaci√≥n paso a paso.</p>
        
        <div class="test-section">
            <h3>üîê PASO 1: Verificar Autenticaci√≥n</h3>
            <div id="authStatus">Verificando...</div>
            <button onclick="checkAuth()">üîÑ Verificar Token</button>
        </div>
        
        <div class="test-section">
            <h3>üìã PASO 2: Listar Mis Rifas</h3>
            <div id="rifasList">No cargadas a√∫n</div>
            <button onclick="loadRifas()">üìã Cargar Mis Rifas</button>
        </div>
        
        <div class="test-section">
            <h3>üéØ PASO 3: Seleccionar Rifa y N√∫mero</h3>
            <div class="input-group">
                <label>Rifa ID: </label>
                <select id="rifaSelect">
                    <option value="">Selecciona una rifa</option>
                </select>
                <button onclick="loadRifaDetails()">üìä Cargar Detalles</button>
            </div>
            <div id="rifaDetails">Selecciona una rifa primero</div>
        </div>
        
        <div class="test-section">
            <h3>üóëÔ∏è PASO 4: Probar Eliminaci√≥n</h3>
            <div class="input-group">
                <label>N√∫mero a eliminar (0-99): </label>
                <input type="number" id="numberToDelete" min="0" max="99" placeholder="ej: 15">
                <button class="danger" onclick="testDeleteNumber()">üóëÔ∏è Eliminar N√∫mero</button>
            </div>
            <div id="deleteResult">Resultado aparecer√° aqu√≠</div>
        </div>
        
        <div class="test-section">
            <h3>üìã Logs y Errores</h3>
            <button onclick="clearLogs()">üßπ Limpiar Logs</button>
            <pre id="logOutput">Logs aparecer√°n aqu√≠...</pre>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let currentToken = localStorage.getItem('authToken');
        let selectedRifaId = null;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logOutput = document.getElementById('logOutput');
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : 'üîç';
            logOutput.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logOutput').textContent = 'Logs limpiados...\n';
        }

        async function checkAuth() {
            const authStatus = document.getElementById('authStatus');
            
            if (!currentToken) {
                authStatus.innerHTML = '<span style="color: red;">‚ùå No hay token guardado</span>';
                log('No hay token de autenticaci√≥n', 'error');
                return false;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    authStatus.innerHTML = `<span style="color: green;">‚úÖ Autenticado como: ${data.user.username}</span>`;
                    log(`Autenticaci√≥n exitosa: ${data.user.username}`, 'success');
                    return true;
                } else {
                    authStatus.innerHTML = '<span style="color: red;">‚ùå Token inv√°lido o expirado</span>';
                    log(`Error de autenticaci√≥n: ${response.status}`, 'error');
                    return false;
                }
            } catch (error) {
                authStatus.innerHTML = '<span style="color: red;">‚ùå Error de conexi√≥n</span>';
                log(`Error de conexi√≥n: ${error.message}`, 'error');
                return false;
            }
        }

        async function loadRifas() {
            if (!await checkAuth()) return;

            try {
                const response = await fetch(`${API_BASE}/rifas/my`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const rifasList = document.getElementById('rifasList');
                    const rifaSelect = document.getElementById('rifaSelect');
                    
                    if (data.rifas && data.rifas.length > 0) {
                        let html = `<p>‚úÖ ${data.rifas.length} simulaciones encontradas:</p><ul>`;
                        rifaSelect.innerHTML = '<option value="">Selecciona una rifa</option>';
                        
                        data.rifas.forEach(rifa => {
                            html += `<li><strong>${rifa.title}</strong> (ID: ${rifa.id}) - ${rifa.numbers_sold}/100 n√∫meros</li>`;
                            rifaSelect.innerHTML += `<option value="${rifa.id}">${rifa.title} (${rifa.numbers_sold}/100)</option>`;
                        });
                        html += '</ul>';
                        rifasList.innerHTML = html;
                        log(`${data.rifas.length} rifas cargadas exitosamente`, 'success');
                    } else {
                        rifasList.innerHTML = '<p>‚ö†Ô∏è No tienes simulaciones creadas a√∫n</p>';
                        log('No hay rifas para mostrar', 'info');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                document.getElementById('rifasList').innerHTML = '<p style="color: red;">‚ùå Error cargando rifas</p>';
                log(`Error cargando rifas: ${error.message}`, 'error');
            }
        }

        async function loadRifaDetails() {
            const rifaId = document.getElementById('rifaSelect').value;
            if (!rifaId) {
                alert('Selecciona una rifa primero');
                return;
            }

            selectedRifaId = rifaId;

            try {
                const response = await fetch(`${API_BASE}/rifas/my/${rifaId}`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const rifa = data.rifa;
                    
                    let details = `
                        <p><strong>T√≠tulo:</strong> ${rifa.title}</p>
                        <p><strong>N√∫meros vendidos:</strong> ${rifa.numbers_sold}/100</p>
                        <p><strong>Estado:</strong> ${rifa.status}</p>
                    `;
                    
                    if (rifa.sold_numbers && rifa.sold_numbers.length > 0) {
                        details += `<p><strong>N√∫meros ocupados:</strong> [${rifa.sold_numbers.slice(0, 20).join(', ')}${rifa.sold_numbers.length > 20 ? '...' : ''}]</p>`;
                    }
                    
                    document.getElementById('rifaDetails').innerHTML = details;
                    log(`Detalles cargados para rifa ${rifaId}`, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                document.getElementById('rifaDetails').innerHTML = '<p style="color: red;">‚ùå Error cargando detalles</p>';
                log(`Error cargando detalles: ${error.message}`, 'error');
            }
        }

        async function testDeleteNumber() {
            if (!selectedRifaId) {
                alert('Selecciona una rifa primero');
                return;
            }

            const numberToDelete = document.getElementById('numberToDelete').value;
            if (!numberToDelete) {
                alert('Ingresa un n√∫mero a eliminar');
                return;
            }

            const number = parseInt(numberToDelete);
            if (number < 0 || number > 99) {
                alert('El n√∫mero debe estar entre 0 y 99');
                return;
            }

            log(`Intentando eliminar n√∫mero ${number} de rifa ${selectedRifaId}...`, 'info');

            try {
                const response = await fetch(`${API_BASE}/rifas/${selectedRifaId}/numbers/${number}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('deleteResult').innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Eliminaci√≥n Exitosa</h4>
                            <p><strong>N√∫mero eliminado:</strong> ${data.deleted_number}</p>
                            <p><strong>Participante:</strong> ${data.participant_name || 'N/A'}</p>
                            <p><strong>Mensaje:</strong> ${data.message}</p>
                        </div>
                    `;
                    log(`‚úÖ N√∫mero ${number} eliminado exitosamente`, 'success');
                } else {
                    document.getElementById('deleteResult').innerHTML = `
                        <div class="error">
                            <h4>‚ùå Error en la Eliminaci√≥n</h4>
                            <p><strong>C√≥digo:</strong> ${response.status}</p>
                            <p><strong>Error:</strong> ${data.error}</p>
                        </div>
                    `;
                    log(`‚ùå Error ${response.status}: ${data.error}`, 'error');
                }
            } catch (error) {
                document.getElementById('deleteResult').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Error de Conexi√≥n</h4>
                        <p>${error.message}</p>
                    </div>
                `;
                log(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        // Inicializar
        checkAuth();
        
        // Log inicial
        log('üîß Sistema de debug iniciado');
        log('üëÜ Usa los botones para probar cada paso');
    </script>
</body>
</html>
